# gas-structifier

`gas-structifier` is a Google Apps Script library designed to help transform unstructured data in Google Sheets into structured data based on a specified schema. For example, it simplifies organizing free-text survey data collected via Google Form. This library is easy to use through custom functions.

---

## Key Features

- **STRUCTIFY**: Converts unstructured text data into structured data based on a specified schema.
- **SCHEMIFY**: Converts natural language descriptions of schemas into a schema table format that can be used directly with STRUCTIFY.

---

## Installation

1. **Add the library to your Google Apps Script project**

   - Open the script editor (e.g., from Google Sheets: `Extensions > Apps Script`).
   - Select `Libraries` from the menu and enter the following script ID to add the library:
     ```
     Script ID: 1EDhKN-alioE4fwlEaPYJWbxJbIgHnpKUrJJs1HSud1y1rJatdKkBdAJI
     ```
   - Select the latest version and save.

2. **Use custom functions in your spreadsheet**

   - The following custom functions will become available:
     - `STRUCTIFY`
     - `SCHEMIFY`

---

## Usage

### STRUCTIFY Function

#### Overview

The `STRUCTIFY` function processes input data against a schema and converts it into structured data. It is designed to handle unstructured text data and return results based on a defined schema.

#### Inputs

- **`inputRange`**: A 2D array where:
  - The first column contains unique identifiers (e.g., IDs).
  - The second column contains unstructured text data to be processed.
  - Example:
    ```
    [
      ["ID_1", "John Doe is 29 years old."],
      ["ID_2", "Jane Smith, born in 1993, is a software engineer."]
    ]
    ```
- **`schemaRange`**: A 2D array where:
  - The first row contains column names (keys) in snake_case.
  - The second row contains descriptions of each column.
  - The third row defines the data type (`string`, `number`, `date`, or `boolean`).
  - Example:
    ```
    [
      ["name", "age"],
      ["User's name", "User's age"],
      ["string", "number"]
    ]
    ```

#### Output

- Returns a string where each row of structured data is joined by commas, and rows are separated by the specified row separator (default is `"|"`).
- Example output:
  ```
  "ID_1,John Doe,29|ID_2,Jane Smith,30"
  ```

#### Function Role

This function is particularly useful for transforming survey responses, chat logs, or any free-form text data into structured rows based on predefined rules, making further analysis easier in Google Sheets.

---

### SCHEMIFY Function

#### Overview

The `SCHEMIFY` function generates a schema table from a natural language description. It helps automate schema creation by converting human-readable descriptions into a structured schema format.

#### Inputs

- **`naturalLanguageInput`**: A string describing the attributes to be included in the schema.
  - Example input: `"Name and age of a user"`

#### Output

- Returns a 2D array formatted as:
  - The first row contains column names (keys) in snake_case.
  - The second row contains descriptions of each column, preserving the language of the input description.
  - The third row defines the data type (`string`, `number`, `date`, or `boolean`).
  - Example output:
    ```
    [
      ["name", "age"],
      ["The user's name", "The user's age"],
      ["string", "number"]
    ]
    ```

#### Function Role

The output of the `SCHEMIFY` function is designed to integrate seamlessly with the `STRUCTIFY` function. This means you can use the schema generated by `SCHEMIFY` as the `schemaRange` input for `STRUCTIFY`, enabling an efficient workflow for processing natural language descriptions into structured data.

---

### Using STRUCTIFY and SCHEMIFY as Custom Functions

To use the `STRUCTIFY` and `SCHEMIFY` functions in your Google Sheets:

Add the following wrapper functions to your Google Apps Script project:

```javascript
function STRUCTIFY(i, s) {
  return gasstructifier.STRUCTIFY(i, s);
}

function SCHEMIFY(s) {
  return gasstructifier.SCHEMIFY(s);
}
```

You can then call these functions directly in your Google Sheets as custom functions, for example:

- `=STRUCTIFY(A1:B10, D1:E3)`
- `=SCHEMIFY("Name and age")`

---

### Efficiently Handling Large Data

When processing a large number of rows, the 30-second timeout limit for custom functions in Google Sheets can become a bottleneck. To address this, process each row individually and combine the results using formulas in Google Sheets.

#### Workflow

1. **Add a new column in the sheet to store STRUCTIFY results**:
   - Apply the `STRUCTIFY` function row-by-row for each input text.
2. **Combine results into a single output**:
   - Use the following formula in a separate sheet to aggregate and parse the STRUCTIFY outputs:
     ```
     =ARRAYFORMULA(SPLIT(TRANSPOSE(SPLIT(TEXTJOIN("|", TRUE, ColumnRange), "|")), ","))
     ```
     - Replace `ColumnRange` with the range of the column storing STRUCTIFY results.

#### Sample Spreadsheet

A sample spreadsheet has been created to demonstrate the usage of `gas-structifier`. You can view it [here](https://docs.google.com/spreadsheets/d/1CmPEjM595miyoDUxDl_xB11zpoiVx08iRrkIcYYst7U/edit?gid=1965312518#gid=1965312518). *(View-only access)*

This approach ensures that you can process multiple rows without hitting the timeout limit, while keeping your data organized and structured.

---

## Error Handling

### STRUCTIFY

- **Input Errors**:
  - `inputRange` is not a 2-column range.
  - `schemaRange` has an invalid format.
- **Schema Errors**:
  - Mismatch between schema types and input data.

### SCHEMIFY

- **Input Errors**:
  - Invalid or unsupported natural language schema descriptions.

---

## OpenAI API Key Requirement

This library uses the OpenAI API to process and generate structured data. To use this library, you need to set up your OpenAI API key in the script editor.

### How to Set Your OpenAI API Key

1. Open the Google Apps Script Editor.
2. Run the following function to securely store your OpenAI API key:
   ```javascript
   setOpenAIKey("YOUR_OPENAI_API_KEY");
   ```
   Replace `YOUR_OPENAI_API_KEY` with your actual API key.
3. Once the key is set, you can verify it using the `checkToken()` function. If the key is not set correctly, an error message will guide you on how to proceed.

### Example

- **Setting the Key**:
  ```javascript
  setOpenAIKey("sk-abc123...");
  ```
  This securely saves the API key in your Google Apps Script environment.

- **Checking the Key**:
  ```javascript
  checkToken();
  ```
  This will return a success message if the key is correctly set.

- **Using the Key**:
  The key is automatically retrieved whenever the library communicates with the OpenAI API.

---

## License

This project is licensed under the MIT License.

